name: CI

on:
  push:
  pull_request:

jobs:
  renode-smoke:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Run Renode smoke test
        uses: antmicro/renode-test-action@v4
        with:
          renode-revision: master
          tests-to-run: tests/smoke.robot

  agent-build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake build-essential libasio-dev libtinyxml2-dev
      - name: Build Micro XRCE-DDS Agent
        run: |
          git clone --depth 1 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
          cd Micro-XRCE-DDS-Agent && mkdir build && cd build
          cmake ..
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig
      - name: Sanity check Agent CLI
        run: MicroXRCEAgent --help | head -n 30

  renode-multinode:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Run Renode Quark 2-node demo
        uses: antmicro/renode-test-action@v4
        with:
          renode-revision: master
          tests-to-run: tests/multinode.robot
  renode-two-nodes:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Run Renode NRF two-node (Robot)
        uses: antmicro/renode-test-action@v4
        with:
          renode-revision: master
          tests-to-run: tests/two_nodes.robot
          artifacts-path: artifacts/two_nodes

      - name: Upload Robot reports (two-nodes)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renode-two-nodes-reports
          path: artifacts/two_nodes/**
  agent-udp-smoke:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake build-essential libasio-dev libtinyxml2-dev iproute2

      - name: Build Micro XRCE-DDS Agent
        run: |
          git clone --depth 1 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
          cd Micro-XRCE-DDS-Agent && mkdir build && cd build
          cmake ..
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Launch Agent (udp4:8888) briefly and verify port
        run: |
          set -euo pipefail
          # 短暫啟動 Agent（最多 5 秒），讓它綁定 8888/UDP
          timeout 5s MicroXRCEAgent udp4 -p 8888 &
          AGG_PID=$!
          # 等半秒讓 Agent 起來
          sleep 0.5
          # 檢查 8888/udp 是否被綁定
          ss -lun | grep -q ':8888' && echo "UDP 8888 is bound by Agent."
          # 等待背景 timeout 自動收掉 Agent（最多 5 秒）
          wait $AGG_PID || true
  agent-tcp-connect:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake build-essential libasio-dev libtinyxml2-dev iproute2 python3

      - name: Build Micro XRCE-DDS Agent
        run: |
          git clone --depth 1 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
          cd Micro-XRCE-DDS-Agent && mkdir build && cd build
          cmake ..
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Launch Agent (tcp4:8888) and connect with Python socket
        run: |
          set -euo pipefail
          # 背景啟動 Agent（最多 8 秒，由 timeout 收掉）
          timeout 8s MicroXRCEAgent tcp4 -p 8888 &
          AG_PID=$!
          # 等 Agent 起來
          sleep 0.5
          # 用 Python 標準庫建立 TCP 連線到 127.0.0.1:8888，維持 ~1s 後關閉
          python3 - <<'PY'
          import socket, time
          s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
          s.settimeout(5.0)
          s.connect(("127.0.0.1", 8888))
          time.sleep(1.0)   # 保持連線片刻
          s.close()
          PY
          # 確認有 ESTAB 連線曾建立（允許很快關閉，因此用 || true 避免時間窗口誤判）
          ss -ptn | grep -E ':8888\s' || true
          # 等待 Agent 結束（timeout 會 kill）
          wait $AG_PID || true
  xrce-helloworld:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake build-essential libasio-dev libtinyxml2-dev iproute2

      - name: Build & install Micro XRCE-DDS Agent (per docs)
        run: |
          git clone --depth 1 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
          cd Micro-XRCE-DDS-Agent && mkdir build && cd build
          cmake ..
          make -j"$(nproc)"
          sudo make install
          sudo ldconfig

      - name: Launch Agent (udp4:2019) in background
        run: |
          set -euo pipefail
          timeout 15s MicroXRCEAgent udp4 -p 2019 --verbose 4 > agent.log 2>&1 &
          echo $! > agent.pid
          # 稍等 Agent 起來
          sleep 0.8
          ss -lun | grep -q ':2019' || (echo "Agent UDP 2019 not bound" && cat agent.log && exit 1)

      - name: Build Micro XRCE-DDS Client examples (per docs)
        run: |
          git clone --depth 1 https://github.com/eProsima/Micro-XRCE-DDS-Client.git
          cd Micro-XRCE-DDS-Client && mkdir build && cd build
          cmake .. -DUCLIENT_BUILD_EXAMPLES=ON
          make -j"$(nproc)"

      - name: Run Subscriber then Publisher against Agent (HelloWorld)
        working-directory: Micro-XRCE-DDS-Client/build
        run: |
          set -euo pipefail
          # 背景啟動 Subscriber，等待訊息後自行退出
          timeout 10s examples/SubscribeHelloWorld/SubscribeHelloWorldClient 127.0.0.1 2019 > ../../sub.out 2>&1 &
          SUB_PID=$!
          # 等待 subscriber 完成初始化
          sleep 0.8
          # 啟動 Publisher（單次發佈並退出）
          timeout 6s examples/PublishHelloWorld/PublishHelloWorldClient 127.0.0.1 2019 > ../../pub.out 2>&1
          # 等待 Subscriber 結束（若已收訊息通常會正常退出）
          wait $SUB_PID || true

      - name: Teardown Agent and collect logs
        if: always()
        run: |
          if [ -f agent.pid ]; then kill $(cat agent.pid) 2>/dev/null || true; fi
          sleep 0.3
          # 將 log/輸出收集成 artifacts
          mkdir -p artifacts/xrce-helloworld
          mv agent.log artifacts/xrce-helloworld/ || true
          mv sub.out pub.out artifacts/xrce-helloworld/ || true

      - name: Upload XRCE HelloWorld artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xrce-helloworld-logs
          path: artifacts/xrce-helloworld/**

